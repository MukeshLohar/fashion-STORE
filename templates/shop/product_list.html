{% extends 'base.html' %}

{% block title %}Fashion Store - Latest Collection{% endblock %}

{% block breadcrumb %}
<div class="container">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Home</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold mb-4">Welcome to Fashion Store</h1>
        <p class="lead mb-4">Discover the latest trends in fashion. Quality clothing for every style and occasion.</p>
        <a href="#products" class="btn btn-light btn-lg">
            <i class="bi bi-arrow-down"></i> Explore Collection
        </a>
    </div>
</section>

<!-- Categories Section -->
{% if categories %}
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">Shop by Category</h2>
        <div class="row">
            {% for category in categories %}
            <div class="col-md-3 col-sm-6 mb-4">
                <div class="card h-100 text-center">
                    {% if category.image %}
                        <img src="{{ category.image.url }}" class="card-img-top" alt="{{ category.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                        <div class="card-img-top bg-primary d-flex align-items-center justify-content-center" style="height: 200px;">
                            <i class="bi bi-tag text-white" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ category.name }}</h5>
                        <p class="card-text">{{ category.description|truncatewords:10 }}</p>
                        <a href="{% url 'shop:category_detail' category.slug %}" class="btn btn-primary">
                            View Products <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Featured Products Section -->
{% if featured_products %}
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">Featured Products</h2>
        <div class="row">
            {% for product in featured_products %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="position-relative">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                        {% else %}
                            <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        
                        {% if not product.is_in_stock %}
                            <span class="badge bg-danger position-absolute top-0 end-0 m-2">Out of Stock</span>
                        {% elif product.stock < 5 %}
                            <span class="badge bg-warning position-absolute top-0 end-0 m-2">Low Stock</span>
                        {% endif %}
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text text-muted small">{{ product.category.name }}</p>
                        <p class="card-text flex-grow-1">{{ product.description|truncatewords:15 }}</p>
                        
                        <div class="mt-auto">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h4 class="text-primary mb-0">₹{{ product.price }}</h4>
                                    <small class="text-muted">{{ product.size }} | {{ product.get_color_display }}</small>
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-12">
                                    <a href="{% url 'shop:product_detail' product.slug %}" class="btn btn-primary w-100">
                                        View Details <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="text-center mt-4">
            <a href="{% url 'shop:product_search' %}" class="btn btn-outline-primary btn-lg">
                View All Products <i class="bi bi-arrow-right"></i>
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- All Products Section -->
<section id="products" class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>All Products</h2>
                    <div class="d-flex gap-2">
                        <a href="{% url 'shop:product_search' %}" class="btn btn-outline-primary">
                            <i class="bi bi-funnel"></i> Filters
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        {% if products %}
        <div class="row">
            {% for product in products %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="position-relative">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" class="card-img-top product-image" alt="{{ product.name }}">
                        {% else %}
                            <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        
                        {% if not product.is_in_stock %}
                            <span class="badge bg-danger position-absolute top-0 end-0 m-2">Out of Stock</span>
                        {% elif product.stock < 5 %}
                            <span class="badge bg-warning position-absolute top-0 end-0 m-2">Low Stock</span>
                        {% endif %}
                        
                        <!-- Wishlist Button -->
                        {% if user.is_authenticated %}
                        <button class="btn btn-outline-light position-absolute top-0 start-0 m-2" 
                                onclick="toggleWishlist({{ product.id }})" 
                                title="Add to Wishlist">
                            <i class="bi bi-heart"></i>
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text text-muted small">{{ product.category.name }}</p>
                        <p class="card-text flex-grow-1">{{ product.description|truncatewords:10 }}</p>
                        
                        <div class="mt-auto">
                            <div class="row align-items-center mb-2">
                                <div class="col">
                                    <h4 class="text-primary mb-0">₹{{ product.price }}</h4>
                                    <small class="text-muted">{{ product.size }} | {{ product.get_color_display }}</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-8">
                                    <a href="{% url 'shop:product_detail' product.slug %}" class="btn btn-primary w-100">
                                        View Details
                                    </a>
                                </div>
                                <div class="col-4">
                                    {% if product.is_in_stock %}
                                    <form method="post" action="{% url 'shop:cart_add' product.id %}" class="add-to-cart-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="btn btn-outline-primary w-100" title="Add to Cart">
                                            <i class="bi bi-bag-plus"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Product pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-box-seam display-1 text-muted"></i>
            <h3 class="mt-3">No Products Available</h3>
            <p class="text-muted">Check back later for new arrivals!</p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Add to cart functionality
document.querySelectorAll('.add-to-cart-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart count in navbar
                const cartBadge = document.querySelector('.cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = data.cart_count;
                } else if (data.cart_count > 0) {
                    // Create cart badge if it doesn't exist
                    const cartLink = document.querySelector('.nav-link[href*="cart"]');
                    const badge = document.createElement('span');
                    badge.className = 'cart-badge';
                    badge.textContent = data.cart_count;
                    cartLink.appendChild(badge);
                }
                
                // Show success message
                showToast(data.message, 'success');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error adding product to cart', 'error');
        });
    });
});

// Wishlist functionality
function toggleWishlist(productId) {
    fetch(`/wishlist/add/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Update heart icon
            const heartIcon = event.target.closest('button').querySelector('i');
            if (data.created) {
                heartIcon.className = 'bi bi-heart-fill text-danger';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating wishlist', 'error');
    });
}

// Toast notification function
function showToast(message, type) {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '1055';
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast container after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        toastContainer.remove();
    });
}
</script>
{% endblock %}